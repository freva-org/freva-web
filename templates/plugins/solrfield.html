{% load custom_filters %}

<input
  type="hidden"
  class="col-md-12 col-xs-12 {{attrs.class}}"
  value="{% if value %}{{ value|safe }}{%endif%}"
  id="{{ attrs.id }}"
  name="{{name}}"
  style="margin: 0px; padding: 0px"
  data-facet="{{facet}}"
  data-group="{{group}}"
  data-multiple="{{multiple}}"
/>

<script>
  $(document).ready(function() {
    (function() {
      let cachedData = null;
      let isFetching = false;
      let pendingCallbacks = [];
      
      function fetchData(callback) {
          if (cachedData) {
              callback(cachedData);
              return;
          }
          
          pendingCallbacks.push(callback);
          if (isFetching) return;
          
          isFetching = true;
          const tmp_data = { facets : '{{facet}}' };
          const tmp_data2 = getActiveFacets('{{facet}}','{{group}}');
          let url = '/api/freva-nextgen/databrowser/metadata-search/freva/file?';
          $.each(tmp_data, function(index, value){
              url += index+'='+value+'&';
          });
          url += tmp_data2 + '{{predefined_facets|dict_to_url}}';
          if (url.slice(-1) === "&") url = url.slice(0, -1);
          
          $.getJSON(url)
              .done(function(data) {
                  cachedData = data;
                  while (pendingCallbacks.length > 0) {
                      pendingCallbacks.shift()(data);
                  }
              })
              .fail(function() {
                  while (pendingCallbacks.length > 0) {
                      pendingCallbacks.shift()(null);
                  }
              })
              .always(function() {
                  isFetching = false;
              });
      }
      
      $("#{{ attrs.id }}").select2({
          {% if not editable %}
              minimumResultsForSearch: -1,
          {% endif %}
          placeholder: "Select a {{ facet }}",
          allowClear: true,
          initSelection : function (element, callback) {
              if('{{multiple}}'=='True'){
                  var data = [];
                  var vals = element.val().split(",")
                  $.each(vals, function(key,value){
                      data.push({
                          id: value,
                          text: value
                      });
                  });
              } else {
                  var data = {id: element.val(), text: element.val()};
              }
              callback(data);
          },
          {% if multiple %}
              multiple:true,
          {%endif%}

          query: function(q) {
              var term = (q.term || "").replace('/','').toLowerCase();
              
              fetchData(function(data) {
                  if (!data) {
                      q.callback({ results: [] });
                      return;
                  }
                  
                  const res_data = [];
                  $.each(data['facets']['{{facet}}'], function(index,value){
                      if(index%2 == 0 && (!term || value.toLowerCase().includes(term))){
                          res_data.push({'id': value,'text': value});
                      }
                  });
                  q.callback({results: res_data});
              });
          },
          
          createSearchChoice:function(term, data) {
              if ( $(data).filter( function() {
                  return this.text.localeCompare(term) === 0;
              }).length === 0) {
                  return {id:term, text:term};
              }
          },
      });
      
      $("#{{ attrs.id }}").on('select2-close select2:close', function() {
          cachedData = null;
          pendingCallbacks = [];
      });
    })()
  });
</script>
